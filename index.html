<!--
ScubaGoggles Static Web Application - stlite Implementation

This file implements a complete static web application that runs ScubaGoggles
configuration interface entirely in the browser using stlite technology.

Key Technologies:
- stlite: Browser-based Streamlit runtime using WebAssembly
- Pyodide: Python interpreter compiled to WebAssembly
- GitHub Pages: Static hosting service

Application Architecture:
1. HTML container with loading/error states
2. CSS styling for professional appearance
3. JavaScript stlite mount configuration
4. Embedded Python Streamlit application
5. Pre-processed baseline policy data

Conversion Strategy:
- Original: Server-side Streamlit app requiring Python backend
- Converted: Client-side stlite app running Python in browser
- Benefits: Zero hosting cost, global CDN distribution, no server maintenance

Maintenance Notes:
- Python code is embedded as JavaScript template literal
- Baseline policy data is pre-processed and embedded
- stlite version 0.31.0 includes Streamlit 1.21.0
- Only browser-compatible Python packages can be used

Author: CISA ScubaGoggles Team
Last Updated: 2026-01-14
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Standard HTML5 document metadata -->
    <meta charset="UTF-8">  <!-- Ensure proper text encoding for international characters -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- Responsive design for mobile devices -->
    <title>ScubaGoggles Configuration Interface</title>  <!-- Browser tab title -->
    <meta name="description" content="Professional ScubaGoggles Configuration Interface for Google Workspace Security Assessment">  <!-- SEO and accessibility description -->
    
    <!-- stlite Framework CSS - Required for Streamlit components to render correctly -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.css" />
    
    <!-- Custom Professional Styling - Overrides default stlite styles to match ScubaGear branding -->
    <style>
        /* Base Body Styling - Clean foundation for the application */
        body {
            margin: 0;  /* Remove default browser margins */
            padding: 0;  /* Remove default browser padding */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  /* Professional font stack */
            background-color: #f5f5f5;  /* Light gray background */
        }
        
        /* Loading Screen Styling - Displayed while stlite initializes */
        .loading-container {
            display: flex;  /* Flexbox for easy centering */
            flex-direction: column;  /* Stack elements vertically */
            justify-content: center;  /* Center vertically */
            align-items: center;  /* Center horizontally */
            min-height: 100vh;  /* Full viewport height */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  /* Professional gradient */
            color: white;  /* White text on dark background */
            text-align: center;  /* Center align text */
        }
        
        /* Animated Loading Spinner - Visual feedback during initialization */
        .loading-spinner {
            width: 50px;  /* Fixed spinner size */
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);  /* Semi-transparent border */
            border-radius: 50%;  /* Perfect circle */
            border-top-color: white;  /* Highlighted top border for animation */
            animation: spin 1s ease-in-out infinite;  /* Continuous rotation */
            margin-bottom: 20px;  /* Space below spinner */
        }
        
        /* Keyframe Animation for Spinner - Smooth 360-degree rotation */
        @keyframes spin {
            to { transform: rotate(360deg); }  /* Full rotation */
        }
        
        .logo {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .tagline {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        /* Application Container - Houses the main Streamlit application */
        #stlite-main {
            height: 100vh;  /* Full viewport height for immersive experience */
            width: 100vw;   /* Full viewport width */
        }
        
        /* Error Screen Styling - Displayed if stlite fails to load */
        .error-container {
            display: none;  /* Hidden by default, shown via JavaScript on error */
            flex-direction: column;  /* Vertical stack layout */
            justify-content: center;  /* Center vertically */
            align-items: center;     /* Center horizontally */
            min-height: 100vh;       /* Full screen coverage */
            background-color: #ff6b6b;  /* Error red background */
            color: white;            /* White text for contrast */
            text-align: center;      /* Center align error text */
            padding: 20px;           /* Padding for mobile devices */
        }
        
        /* Error Message Container - Constrains width for readability */
        .error-message {
            max-width: 600px;  /* Maximum width for optimal reading */
            line-height: 1.6;  /* Improved line spacing for readability */
        }
    </style>
</head>
<body>
    <!-- Loading Screen - Displayed during stlite initialization -->
    <!-- This provides immediate visual feedback while Python and dependencies load -->
    <div id="loading" class="loading-container">
        <div class="loading-spinner"></div>  <!-- Animated spinner for visual interest -->
        <div class="logo">ü§ø ScubaGoggles</div>  <!-- Application branding -->
        <div class="tagline">Google Workspace Security Assessment Tool</div>  <!-- Descriptive tagline -->
        <p>Loading Configuration Interface...</p>  <!-- Status message -->
        <p style="font-size: 0.9em; opacity: 0.7;">Please wait while we prepare your security assessment dashboard</p>  <!-- Additional context -->
    </div>
    
    <!-- Error Screen - Displayed if stlite fails to initialize -->
    <!-- Provides user-friendly error messages and recovery options -->
    <div id="error" class="error-container">
        <div class="logo">‚ö†Ô∏è Error</div>  <!-- Error icon and text -->
        <div class="error-message">
            <h2>Failed to Load ScubaGoggles Interface</h2>
            <p>There was an error loading the application. This could be due to:</p>
            <ul style="text-align: left;">  <!-- Left-aligned list for better readability -->
                <li>Network connectivity issues</li>  <!-- Common troubleshooting points -->
                <li>Browser compatibility problems</li>
                <li>Temporary service unavailability</li>
            </ul>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: white; color: #ff6b6b; border: none; border-radius: 5px; cursor: pointer;">
                Retry  <!-- Reload button for recovery attempts -->
            </button>
        </div>
    </div>
    
    <!-- Main Application Container - Where the Streamlit app will be mounted -->
    <!-- This div serves as the mount point for the stlite-powered Streamlit application -->
    <div id="stlite-main"></div>

    <!-- stlite JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.js"></script>
    
    <script>
        // stlite Configuration and Application Bootstrap
        // This section configures and launches the Python Streamlit application in the browser
        
        // Python Package Requirements - Only packages not pre-installed in stlite
        // Note: stlite comes with streamlit, numpy, pandas, and other common packages pre-installed
        const requirements = [
            "pyyaml"  // YAML parsing library for configuration file handling
        ];
        
        // User Interface State Management Functions
        // These functions handle the loading and error states of the application
        
        // Hide loading screen and display error interface on initialization failure
        function showError() {
            document.getElementById('loading').style.display = 'none';  // Hide loading animation
            document.getElementById('error').style.display = 'flex';   // Show error message
        }
        
        // Hide loading screen and display main application on successful initialization
        function showApp() {
            document.getElementById('loading').style.display = 'none';  // Hide loading animation
            // Note: stlite-main container will automatically show when app mounts
        }
        
        // Mount the Streamlit app
        stlite.mount(
            {
                requirements: requirements,
                entrypoint: "streamlit_app.py",
                files: {
                    "streamlit_app.py": `# ScubaGoggles Configuration Interface - Enhanced stlite Version

import streamlit as st
import yaml
from typing import Dict, Any, List
import os
from datetime import date
import json

# Configure page
st.set_page_config(
    page_title="ScubaGoggles Configuration Editor",
    page_icon="ü§ø",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Parse baseline policies from embedded data
def parse_baseline_policies():
    """Parse policies from baseline data"""
    
    # Since we can't read files in stlite, we'll embed key policy data
    baseline_policies = {
        'COMMONCONTROLS': {
            'GWS.COMMONCONTROLS.1.1v0.6': 'Phishing-Resistant MFA SHALL be required for all users.',
            'GWS.COMMONCONTROLS.1.2v0.6': 'Post SSO verification SHOULD be enabled for users signing in using the SSO profile for your organization.',
            'GWS.COMMONCONTROLS.1.3v0.6': 'Post SSO verification SHOULD be enabled for users signing in using other SSO profiles.',
            'GWS.COMMONCONTROLS.1.4v0.6': 'Users SHALL be forced to re-authenticate after an established 12-hour GWS login session has expired.',
            'GWS.COMMONCONTROLS.1.5v0.6': 'User password strength SHALL be enforced.',
            'GWS.COMMONCONTROLS.2.1v0.6': 'User password length SHALL be at least 12 characters.',
            'GWS.COMMONCONTROLS.3.1v0.6': 'Users SHALL be forced to re-authenticate after an established 12-hour GWS login session has expired.',
            'GWS.COMMONCONTROLS.3.2v0.6': 'User password strength SHALL be enforced.',
            'GWS.COMMONCONTROLS.4.1v0.6': 'Password policy SHALL be enforced at next sign in.',
            'GWS.COMMONCONTROLS.5.1v0.6': 'User password strength SHALL be enforced.',
            'GWS.COMMONCONTROLS.5.2v0.6': 'User password length SHALL be at least 12 characters.',
            'GWS.COMMONCONTROLS.5.3v0.6': 'User password length SHALL be at least 15 characters.',
            'GWS.COMMONCONTROLS.5.4v0.6': 'Password policy SHALL be enforced at next sign in.',
            'GWS.COMMONCONTROLS.5.5v0.6': 'User passwords SHALL NOT be reused.',
            'GWS.COMMONCONTROLS.5.6v0.6': 'Agencies SHALL NOT allow users to access unconfigured third party apps.',
            'GWS.COMMONCONTROLS.10.5v0.6': 'Access to Google Workspace applications by less secure apps that do not meet security standards for authentication SHALL be prevented.',
            'GWS.COMMONCONTROLS.18.4v0.6': 'The action for the above DLP policies SHALL be set to block external sharing.'
        },
        'GMAIL': {
            'GWS.GMAIL.1.1v0.6': 'External recipient warnings SHALL be enabled.',
            'GWS.GMAIL.2.1v0.6': 'SPF records SHALL be published for all domains.',
            'GWS.GMAIL.3.1v0.6': 'DKIM signing SHALL be enabled.',
            'GWS.GMAIL.4.1v0.6': 'DMARC policy SHALL be published for all domains.',
            'GWS.GMAIL.5.1v0.6': 'Inbound email SHALL be scanned for malware.',
            'GWS.GMAIL.6.1v0.6': 'Email SHALL be scanned for phishing.',
            'GWS.GMAIL.7.1v0.6': 'Enhanced phishing and malware protection SHALL be enabled.',
            'GWS.GMAIL.8.1v0.6': 'Automatic forwarding to external domains SHALL be disabled.',
            'GWS.GMAIL.9.1v0.6': 'POP and IMAP access SHALL be disabled.',
            'GWS.GMAIL.10.1v0.6': 'Comprehensive mail storage SHALL be enabled.',
            'GWS.GMAIL.11.1v0.6': 'Email delegation SHALL be disabled.',
            'GWS.GMAIL.12.1v0.6': 'Per-message filters SHALL be disabled.',
            'GWS.GMAIL.13.1v0.6': 'Spoofing protection SHALL be enabled.'
        },
        'DRIVE': {
            'GWS.DRIVE.1.1v0.6': 'External sharing SHALL be restricted.',
            'GWS.DRIVE.2.1v0.6': 'Link sharing SHALL be disabled for users.',
            'GWS.DRIVE.3.1v0.6': 'Users SHALL NOT be allowed to publish on the web.',
            'GWS.DRIVE.4.1v0.6': 'Received files SHALL be scanned.',
            'GWS.DRIVE.5.1v0.6': 'Users SHALL be warned when sharing outside the domain.',
            'GWS.DRIVE.6.1v0.6': 'Distributing published content via Docs SHALL be disabled.',
            'GWS.DRIVE.7.1v0.6': 'Drive file stream SHALL be disabled for users.',
            'GWS.DRIVE.8.1v0.6': 'Mobile editing SHALL be disabled.',
            'GWS.DRIVE.9.1v0.6': 'Offline access SHALL be disabled.',
            'GWS.DRIVE.10.1v0.6': 'Third party Drive apps SHALL be disabled.',
            'GWS.DRIVE.11.1v0.6': 'Users SHALL NOT be able to install Drive add-ons.',
            'GWS.DRIVE.12.1v0.6': 'Users in this organization SHALL NOT be allowed to share items outside of the domain.'
        },
        'CALENDAR': {
            'GWS.CALENDAR.1.1v0.6': 'External sharing SHALL be disabled.',
            'GWS.CALENDAR.2.1v0.6': 'Calendar interop management SHALL be disabled.',
            'GWS.CALENDAR.3.1v0.6': 'External calendar sharing SHALL be restricted.',
            'GWS.CALENDAR.4.1v0.6': 'Warning for external participants SHALL be enabled.',
            'GWS.CALENDAR.5.1v0.6': 'External calendar invitations SHALL be restricted.'
        },
        'MEET': {
            'GWS.MEET.1.1v0.6': 'External participants SHALL be restricted.',
            'GWS.MEET.2.1v0.6': 'Anonymous users SHALL NOT be allowed to join meetings.',
            'GWS.MEET.3.1v0.6': 'External recording SHALL be disabled.',
            'GWS.MEET.4.1v0.6': 'Meeting recordings SHALL be disabled for users.',
            'GWS.MEET.5.1v0.6': 'Live streaming SHALL be disabled.',
            'GWS.MEET.6.1v0.6': 'Phone access to meetings SHALL be disabled.'
        },
        'GROUPS': {
            'GWS.GROUPS.1.1v0.6': 'External sharing SHALL be disabled.',
            'GWS.GROUPS.2.1v0.6': 'External users SHALL NOT be allowed to join groups.',
            'GWS.GROUPS.3.1v0.6': 'Group creation SHALL be restricted.',
            'GWS.GROUPS.4.1v0.6': 'External members SHALL be restricted.'
        },
        'CHAT': {
            'GWS.CHAT.1.1v0.6': 'External chat SHALL be disabled.',
            'GWS.CHAT.2.1v0.6': 'External users SHALL NOT be allowed in chat.',
            'GWS.CHAT.3.1v0.6': 'File sharing SHALL be restricted in chat.',
            'GWS.CHAT.4.1v0.6': 'Chat history SHALL be enabled.'
        },
        'SITES': {
            'GWS.SITES.1.1v0.6': 'External sharing SHALL be disabled.',
            'GWS.SITES.2.1v0.6': 'Site creation SHALL be restricted.',
            'GWS.SITES.3.1v0.6': 'Public site creation SHALL be disabled.'
        },
        'CLASSROOM': {
            'GWS.CLASSROOM.1.1v0.6': 'External sharing SHALL be disabled.',
            'GWS.CLASSROOM.2.1v0.6': 'Guardian email summaries SHALL be disabled.',
            'GWS.CLASSROOM.3.1v0.6': 'Student unenrollment SHALL be restricted.',
            'GWS.CLASSROOM.4.1v0.6': 'Class creation SHALL be restricted to teachers only.'
        }
    }
    
    return baseline_policies

# Custom CSS for professional styling to match existing design
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(90deg, #4472C4 0%, #2E5984 100%);
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        color: white;
        text-align: center;
    }
    
    .main-title {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .main-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .stTabs [data-baseweb="tab-list"] {
        gap: 8px;
        background-color: #f8f9fa;
        padding: 0.5rem;
        border-radius: 8px;
    }
    
    .stTabs [data-baseweb="tab"] {
        height: 50px;
        white-space: pre-wrap;
        background-color: white;
        border-radius: 6px;
        color: #333;
        font-weight: 500;
        border: 1px solid #dee2e6;
        padding: 0 1.5rem;
    }
    
    .stTabs [aria-selected="true"] {
        background-color: #4472C4 !important;
        color: white !important;
        border-color: #4472C4 !important;
    }
    
    .organization-section {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin: 1rem 0;
        border-left: 4px solid #4472C4;
    }
    
    .policy-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 1rem;
        margin: 0.5rem 0;
    }
    
    .policy-id {
        font-weight: bold;
        color: #4472C4;
        font-size: 0.9rem;
    }
    
    .policy-desc {
        color: #666;
        margin: 0.5rem 0;
        font-size: 0.85rem;
    }
</style>
""", unsafe_allow_html=True)

# Header matching the existing design
st.markdown("""
<div class="main-header">
    <div class="main-title">ü§ø ScubaGoggles Configuration Editor</div>
    <div class="main-subtitle">Create a configuration file for ScubaGoggles exclusions, annotations, and omissions baseline controls</div>
</div>
""", unsafe_allow_html=True)

# Initialize session state
if 'config' not in st.session_state:
    st.session_state.config = {
        'orgname': '',
        'orgunitname': '',
        'description': '',
        'credentials_file': '',
        'output_dir': './ScubaResults',
        'products': ['gmail', 'drive', 'calendar', 'meet'],
        'report_title': 'ScubaGoggles Security Assessment',
        'organization_domain': '',
        'assessment_date': str(date.today()),
        'omitpolicy': [],
        'annotatepolicy': {},
        'breakglassaccounts': [],
        'advanced_settings': {}
    }

# Parse available policies
if 'available_policies' not in st.session_state:
    st.session_state.available_policies = parse_baseline_policies()

# Create tabs matching the existing design
tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
    "üìã Main", 
    "üö´ Omit Policies", 
    "üìù Annotate Policies", 
    "üîì Break Glass", 
    "‚öôÔ∏è Advanced", 
    "üëÅÔ∏è Preview"
])

with tab1:
    st.header("Organization Information")
    
    # Help section
    with st.expander("‚ÑπÔ∏è Help: Organization & Product Selection"):
        st.markdown("""
        ### Organization Information
        Provide details about your organization that will appear in the assessment report.
        
        ### Product Selection
        Choose which Google Workspace products to include in your security assessment:
        - **Gmail**: Email security settings, DLP policies
        - **Drive**: File sharing policies, external access controls
        - **Calendar**: Calendar sharing, privacy settings
        - **Meet**: Meeting security, participant controls
        - **Groups**: Group management, external member policies
        - **Chat**: Chat security, external policies
        - **Sites**: Site sharing policies, publishing settings
        - **Classroom**: Classroom security, privacy controls
        """)
    
    st.markdown('<div class="organization-section">', unsafe_allow_html=True)
    
    # Organization details
    col1, col2 = st.columns(2)
    
    with col1:
        org_name = st.text_input(
            "Organization Name *",
            value=st.session_state.config['orgname'],
            placeholder="Department of Example",
            help="Enter your organization's full name"
        )
        st.session_state.config['orgname'] = org_name
    
    with col2:
        org_unit = st.text_input(
            "Organization Unit Name",
            value=st.session_state.config['orgunitname'],
            placeholder="Subdepartment of Example",
            help="Enter your organizational unit or department"
        )
        st.session_state.config['orgunitname'] = org_unit
    
    description = st.text_area(
        "Description",
        value=st.session_state.config['description'],
        placeholder="Enter a description for this configuration (optional)",
        help="Optional description of this assessment configuration",
        height=100
    )
    st.session_state.config['description'] = description
    
    st.markdown('</div>', unsafe_allow_html=True)
    
    # Product Selection
    st.subheader("üìä Product Selection")
    
    available_products = {
        'gmail': 'Gmail - Email security settings, DLP policies',
        'drive': 'Google Drive - File sharing policies, external access controls',
        'calendar': 'Google Calendar - Calendar sharing, privacy settings',
        'meet': 'Google Meet - Meeting security, participant controls',
        'groups': 'Google Groups - Group management, external member policies',
        'chat': 'Google Chat - Chat security, external policies',
        'sites': 'Google Sites - Site sharing policies, publishing settings',
        'classroom': 'Google Classroom - Classroom security, privacy controls'
    }
    
    # Quick selection buttons
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        if st.button("üì± Select All", use_container_width=True):
            st.session_state.config['products'] = list(available_products.keys())
            st.experimental_rerun()
    
    with col2:
        if st.button("üéØ Select Core", use_container_width=True):
            st.session_state.config['products'] = ['gmail', 'drive', 'calendar', 'meet']
            st.experimental_rerun()
    
    with col3:
        if st.button("üìß Email Only", use_container_width=True):
            st.session_state.config['products'] = ['gmail']
            st.experimental_rerun()
    
    with col4:
        if st.button("‚ùå Clear All", use_container_width=True):
            st.session_state.config['products'] = []
            st.experimental_rerun()
    
    # Product checkboxes
    selected_products = []
    
    col1, col2 = st.columns(2)
    
    products_list = list(available_products.items())
    mid_point = len(products_list) // 2
    
    with col1:
        for product_key, product_desc in products_list[:mid_point]:
            is_selected = st.checkbox(
                product_desc,
                value=product_key in st.session_state.config['products'],
                key=f"product_{product_key}"
            )
            if is_selected:
                selected_products.append(product_key)
    
    with col2:
        for product_key, product_desc in products_list[mid_point:]:
            is_selected = st.checkbox(
                product_desc,
                value=product_key in st.session_state.config['products'],
                key=f"product_{product_key}"
            )
            if is_selected:
                selected_products.append(product_key)
    
    st.session_state.config['products'] = selected_products
    
    if selected_products:
        st.success(f"‚úÖ Selected {len(selected_products)} products: {', '.join([p.title() for p in selected_products])}")
    else:
        st.warning("‚ö†Ô∏è Please select at least one product to assess")

with tab2:
    st.header("üö´ Omit Policies")
    st.info("Configure which security policies to omit from the assessment")
    
    with st.expander("‚ÑπÔ∏è Help: Policy Omission Guidelines"):
        st.markdown("""
        Use this section to exclude specific policies from ScubaGoggles evaluation.
        
        **Important**: Any omitted policies should be carefully considered and documented as part of your organization's cybersecurity risk management program.
        
        **Common reasons for omitting policies:**
        - Policy is implemented by a third-party service that ScubaGoggles cannot audit
        - Policy is not applicable to your organization 
        - Accepting risk for specific controls with proper documentation
        """)
    
    # Get available policies for selected products
    selected_product_policies = {}
    for product in st.session_state.config.get('products', []):
        product_upper = product.upper()
        if product_upper in st.session_state.available_policies:
            selected_product_policies[product_upper] = st.session_state.available_policies[product_upper]
    
    # Add common controls if any product is selected
    if st.session_state.config.get('products', []):
        selected_product_policies['COMMONCONTROLS'] = st.session_state.available_policies['COMMONCONTROLS']
    
    if not selected_product_policies:
        st.warning("‚ö†Ô∏è Please select products in the Main tab to see available policies.")
    else:
        st.subheader("Available Policies from Selected Products:")
        
        # Create tabs for each product
        if len(selected_product_policies) > 1:
            product_tabs = st.tabs(list(selected_product_policies.keys()))
            
            for i, (product_name, policies) in enumerate(selected_product_policies.items()):
                with product_tabs[i]:
                    st.write(f"**{product_name}** policies:")
                    
                    for policy_id, policy_desc in policies.items():
                        col1, col2 = st.columns([5, 1])
                        
                        with col1:
                            st.markdown(f"""
                            <div class="policy-item">
                                <div class="policy-id">{policy_id}</div>
                                <div class="policy-desc">{policy_desc}</div>
                            </div>
                            """, unsafe_allow_html=True)
                        
                        with col2:
                            is_omitted = policy_id in st.session_state.config.get('omitpolicy', [])
                            
                            if st.button("Omit" if not is_omitted else "Include", 
                                       key=f"omit_{policy_id}",
                                       type="secondary" if not is_omitted else "primary",
                                       use_container_width=True):
                                if is_omitted:
                                    st.session_state.config['omitpolicy'].remove(policy_id)
                                else:
                                    if 'omitpolicy' not in st.session_state.config:
                                        st.session_state.config['omitpolicy'] = []
                                    st.session_state.config['omitpolicy'].append(policy_id)
                                st.experimental_rerun()
    
    # Show omitted policies summary
    omitted_policies = st.session_state.config.get('omitpolicy', [])
    if omitted_policies:
        st.subheader(f"üìã Currently Omitted Policies ({len(omitted_policies)}):")
        for policy in omitted_policies:
            st.write(f"‚Ä¢ {policy}")
    else:
        st.info("‚ÑπÔ∏è No policies are currently omitted")

with tab3:
    st.header("üìù Annotate Policies")
    st.info("Add custom annotations and notes to specific policies")
    
    with st.expander("‚ÑπÔ∏è Help: Policy Annotations"):
        st.markdown("""
        ### Policy Annotations
        Add custom notes, explanations, or exceptions for specific policies in your assessment report.
        
        **Use annotations to:**
        - Explain organizational context for policy implementations
        - Document approved exceptions or alternative controls
        - Provide additional guidance for policy reviewers
        - Reference related documentation or procedures
        """)
    
    # Get available policies for annotation
    available_for_annotation = {}
    for product in st.session_state.config.get('products', []):
        product_upper = product.upper()
        if product_upper in st.session_state.available_policies:
            for policy_id, policy_desc in st.session_state.available_policies[product_upper].items():
                available_for_annotation[policy_id] = f"[{product_upper}] {policy_desc}"
    
    # Add common controls
    if st.session_state.config.get('products', []):
        for policy_id, policy_desc in st.session_state.available_policies['COMMONCONTROLS'].items():
            available_for_annotation[policy_id] = f"[COMMONCONTROLS] {policy_desc}"
    
    if not available_for_annotation:
        st.warning("‚ö†Ô∏è Please select products in the Main tab to annotate policies.")
    else:
        # Add new annotation
        st.subheader("‚ûï Add Policy Annotation")
        
        col1, col2 = st.columns([2, 3])
        
        with col1:
            selected_policy = st.selectbox(
                "Select Policy to Annotate",
                [""] + list(available_for_annotation.keys()),
                format_func=lambda x: f"{x} - {available_for_annotation.get(x, '')[:50]}..." if x else "Select a policy"
            )
        
        with col2:
            if selected_policy:
                annotation_text = st.text_area(
                    "Annotation",
                    placeholder="Enter your annotation or note for this policy...",
                    height=100,
                    key="new_annotation_text"
                )
                
                if st.button("üíæ Add Annotation", type="primary") and annotation_text.strip():
                    if 'annotatepolicy' not in st.session_state.config:
                        st.session_state.config['annotatepolicy'] = {}
                    st.session_state.config['annotatepolicy'][selected_policy] = annotation_text.strip()
                    st.success(f"‚úÖ Annotation added for {selected_policy}")
                    st.experimental_rerun()
        
        # Show existing annotations
        existing_annotations = st.session_state.config.get('annotatepolicy', {})
        if existing_annotations:
            st.subheader(f"üìù Current Annotations ({len(existing_annotations)}):")
            
            for policy_id, annotation in existing_annotations.items():
                col1, col2 = st.columns([4, 1])
                
                with col1:
                    policy_desc = available_for_annotation.get(policy_id, "Unknown policy")
                    st.markdown(f"""
                    <div class="policy-item">
                        <div class="policy-id">{policy_id}</div>
                        <div class="policy-desc">{policy_desc}</div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem;">
                            <strong>Annotation:</strong> {annotation}
                        </div>
                    </div>
                    """, unsafe_allow_html=True)
                
                with col2:
                    if st.button("üóëÔ∏è", key=f"delete_annotation_{policy_id}", help="Delete this annotation"):
                        del st.session_state.config['annotatepolicy'][policy_id]
                        st.experimental_rerun()
        else:
            st.info("‚ÑπÔ∏è No policy annotations added yet")

with tab4:
    st.header("üîì Break Glass Users")
    st.info("Configure emergency access users who may bypass certain policies")
    
    st.markdown("""
    ### Break Glass Access
    Specify users who have emergency "break glass" access and may legitimately bypass certain security policies.
    """)
    
    break_glass_text = st.text_area(
        "Break Glass Users",
        value="\\n".join(st.session_state.config.get('breakglassaccounts', [])),
        placeholder="Enter email addresses of break glass users, one per line:\\nadmin@example.com\\nemergency@example.com",
        help="Enter email addresses of users with emergency access privileges",
        height=150
    )
    
    if break_glass_text:
        st.session_state.config['breakglassaccounts'] = [line.strip() for line in break_glass_text.split('\\n') if line.strip()]
    else:
        st.session_state.config['breakglassaccounts'] = []
    
    if st.session_state.config['breakglassaccounts']:
        st.subheader("üë• Break Glass Users:")
        for user in st.session_state.config['breakglassaccounts']:
            st.write(f"‚Ä¢ {user}")

with tab5:
    st.header("‚öôÔ∏è Advanced Settings")
    st.info("Configure advanced assessment options")
    
    # Credentials and Output
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("üîê Authentication")
        
        # Credentials file upload
        uploaded_file = st.file_uploader(
            "Upload Service Account JSON",
            type=['json'],
            help="Upload your Google Workspace service account credentials file"
        )
        
        if uploaded_file is not None:
            st.session_state.config['credentials_file'] = uploaded_file.name
            st.success(f"‚úÖ Credentials: {uploaded_file.name}")
        
        # Manual path input
        creds_path = st.text_input(
            "Or specify credentials path:",
            value=st.session_state.config['credentials_file'],
            placeholder="/path/to/service-account.json"
        )
        if creds_path:
            st.session_state.config['credentials_file'] = creds_path
    
    with col2:
        st.subheader("üìÅ Output Settings")
        
        output_dir = st.text_input(
            "Output Directory",
            value=st.session_state.config['output_dir'],
            placeholder="./ScubaResults"
        )
        st.session_state.config['output_dir'] = output_dir
        
        report_title = st.text_input(
            "Report Title",
            value=st.session_state.config['report_title'],
            placeholder="ScubaGoggles Security Assessment"
        )
        st.session_state.config['report_title'] = report_title
    
    # Performance Settings
    st.subheader("‚ö° Performance Settings")
    
    col1, col2 = st.columns(2)
    with col1:
        max_threads = st.slider("Max Concurrent Requests", 1, 10, 3)
        
    with col2:
        request_delay = st.slider("Request Delay (seconds)", 0.1, 2.0, 0.5, 0.1)

with tab6:
    st.header("üëÅÔ∏è Preview Configuration")
    st.info("Review your complete configuration before saving")
    
    # Configuration summary
    config_summary = st.session_state.config.copy()
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("üìä Configuration Summary")
        st.metric("Organization", config_summary['orgname'] or "Not set")
        st.metric("Products Selected", f"{len(config_summary['products'])}/8")
        st.metric("Omitted Policies", len(config_summary.get('omitpolicy', [])))
        st.metric("Annotated Policies", len(config_summary.get('annotatepolicy', {})))
        
    with col2:
        st.subheader("üìã Selected Products")
        if config_summary['products']:
            for product in config_summary['products']:
                st.write(f"‚úÖ {product.title()}")
        else:
            st.write("‚ùå No products selected")
    
    # Show omitted policies if any
    if config_summary.get('omitpolicy'):
        st.subheader("üö´ Omitted Policies")
        for policy in config_summary['omitpolicy']:
            st.write(f"‚Ä¢ {policy}")
    
    # Show annotations if any
    if config_summary.get('annotatepolicy'):
        st.subheader("üìù Policy Annotations")
        for policy_id, annotation in config_summary['annotatepolicy'].items():
            st.write(f"**{policy_id}:** {annotation}")
    
    # Full configuration display
    st.subheader("üîß Full Configuration")
    config_yaml = yaml.dump(config_summary, default_flow_style=False, sort_keys=False)
    st.code(config_yaml, language='yaml')
    
    # Download button
    st.download_button(
        label="üíæ Download Configuration File",
        data=config_yaml,
        file_name="scubagoggles_config.yaml",
        mime="text/yaml",
        use_container_width=True
    )

# Footer
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; padding: 20px;">
    ü§ø <strong>ScubaGoggles Configuration Editor</strong> | 
    Professional Google Workspace Security Assessment Tool
</div>
""", unsafe_allow_html=True)`
                }
            },
            document.getElementById("stlite-main"),
            {
                onLoad: showApp,
                onError: showError
            }
        );
    </script>
</body>
</html>